<?php
namespace telegram;

use bitly\RestApi;
use exceptions\FormatException;
use exceptions\ShortLinkNotFoundedException;

require('telegram/Connection.php');
require('Log/FLogger.php');
require('TIniFileEx.php');
require('bitly/RestApi.php');
require_once("exceptions/FormatException.php");

/**
 * Class Bot
 *
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç-–±–æ—Ç—É
 *
 * @package telegram –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram API
 */
class Bot
{

    /**
     * @var Connection
     */
    private $connection;
    /**
     * @var \FLogger –õ–æ–≥–≥–µ—Ä
     */
    private $log;
    /**
     * @var \TIniFileEx
     */
    private $config;
    /**
     * @var \TIniFileEx
     */
    private $configTelegram;
    /**
     * @var string
     */
    private $lastupdate;
    /**
     * @var \TIniFileEx
     */
    private $users;
    /**
     * @var RestApi
     */
    private $bitlyApi;

    /**
     * Bot constructor.
     *
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     *
     */
    public function __construct()
    {
        $this->bitlyApi = new RestApi();
        $this->users = new \TIniFileEx("Log/users.ini");
        $this->config = new \TIniFileEx("config.ini");
        $this->configTelegram = new \TIniFileEx("telegram/config.ini");

        $this->log = new \FLogger($this->config->read('main', "logFile"));
        $this->lastupdate = $this->config->read('main', "lastUpdateID");

        $this->connection = new Connection(
            $this->configTelegram->read('telegram', 'token'),
            $this->configTelegram->read('telegram', 'URL')
        );
    }

    /**
     *
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
     *
     * @param $offset –û—Ç—Å—Ç—É–ø
     * @return array –ú–∞—Å—Å–∏–≤ –æ—Ç–≤–µ—Ç–∞
     */
    public function getUpdates($offset)
    {
        $params = null;
        if (!empty($offset)) {
            $params["offset"] = $offset;
        }
        return $this->connection->request("getUpdates", $params);
    }

    /**
     *
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
     *
     * @param string $text –¢–µ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     * @param string $chatID –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞
     */
    public function sendMessage($text, $chatID)
    {
        $params["text"] = $text;
        $params["chat_id"] = $chatID;
        $params["disable_web_page_preview"] = true;

        $this->connection->request("sendmessage", $params);
    }

    /**
     *
     * –í—ã–≤–æ–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
     *
     * @param string $text –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–æ–±—â–µ–Ω–∏–µ
     * @param string $chatID –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞
     * @param array $keyboards –ú–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫
     * @param array $settings –ú–∞—Å—Å–∏–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫
     */
    public function keyboard($text, $chatID, $keyboards, $settings)
    {
        $replyMarkup = $settings;
        $replyMarkup["keyboard"] = $keyboards;
        $this->log->log(json_encode($replyMarkup));
        $params["text"] = $text;
        $params["chat_id"] = $chatID;
        $params["reply_markup"] = json_encode($replyMarkup);

        $this->connection->request("sendmessage", $params);
    }

    /**
     *
     * –í—ã–≤–æ–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
     *
     * @param string $text –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
     * @param string $chatID –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞
     * @param string $inlineKeyboards –ú–∞—Å—Å–∏–≤ –∫–Ω–æ–ø–æ–∫
     */
    public function inlineKeyboard($text, $chatID, $inlineKeyboards)
    {
        $this->log->log(json_encode($inlineKeyboards));
        $params["text"] = $text;
        $params["chat_id"] = $chatID;
        $params["reply_markup"] = json_encode($inlineKeyboards);

        $this->connection->request("sendmessage", $params);
    }

    /**
     *
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Å—ã–ª–∫—É —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º http
     *
     * @param string $url –°—Å—ã–ª–∫–∞
     * @return string –°—Å—ã–ª–∫–∞ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
     */
    public function addHttp ($url)
    {
        if (!preg_match('/^https?:\/\//', $url)) {
            return "http://" . $url;
        }
        return $url;
    }

    /**
     *
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
     *
     * @param string $message –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
     * @param string $chat_id –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞
     */
    public function sendLink ($message, $chat_id)
    {
        $url = $this->addHttp($message);
        try {
            if (
                preg_match('/^(https?:\/\/)?bit\.ly(\/[\w\.]*)*\/?$/', $url) ||
                preg_match('/^(https?:\/\/)?j\.mp(\/[\w\.]*)*\/?$/', $url)
            ) {
                $this->sendMessage($this->bitlyApi->expand($url), $chat_id);
            } else if (preg_match('/^(https?:\/\/)?([\w\.]+)\.([a-z]{2,6}\.?)(\/[\w&?=\-\.]*)*\/?$/', $message)) {
                $this->sendMessage($this->bitlyApi->createBitlink($url), $chat_id);
            } else {
                throw new FormatException('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏');
            }
        } catch (ShortLinkNotFoundedException $e) {
            $this->sendMessage($e->getMessage(), $chat_id);
        } catch (FormatException $e) {
            $this->sendMessage($e->getMessage(), $chat_id);
        }
    }

    /**
     * –ó–∞–ø—É—Å–∫–∞–µ—Ç —á–∞—Ç-–±–æ—Ç–∞
     */
    public function run()
    {
        while (true) {
            $this->log->log("–∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
            $updates = ((array)$this->getUpdates($this->lastupdate))["result"];
            $this->log->log("–∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à–µ–ª");

            echo "<pre>";
            var_dump($updates);
            echo "</pre>";

            $chat_id = null;
            $chat = null;
            $message = null;
            $update_id = null;

            foreach ($updates as $update) {
                $update_id = ((array)$update)["update_id"];
                $chat = ((array)((array)$update)["message"])["chat"];
                $chat_id = ((array)$chat)["id"];
                $this->log->log("id —á–∞—Ç–∞: " . $chat_id);
                $message = ((array)((array)$update)["message"])["text"];
                $user = ((array)((array)((array)$update)["message"])["from"]);

                switch ($message) {
                    case "/start":
                        if ($user["id"] != null &&
                            $user["id"] != null &&
                            $this->users->read($user["id"],"chat_id", null) != $chat_id)
                        {

                            $this->users->write($user["id"], "first_name", $user["first_name"]);
                            $this->users->write($user["id"], "last_name", $user["last_name"]);
                            $this->users->write($user["id"], "username", $user["username"]);
                            $this->users->write($user["id"], "language", $user["language_code"]);
                            $this->users->write($user["id"], "chat_id", $chat_id);

                            $this->users->updateFile();
                        }

                        $this->log->log("—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã");
                        $keyboards = [["–ò—Å—Ç–æ—Ä–∏—è"], ["–ü–æ–º–æ—â—å"]];
                        $keyboardSettings = array(
                            "resize_keyboard" => true,
                        );
                        $this->keyboard(" f", $chat_id, $keyboards, $keyboardSettings);
                        $this->log->log("–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞");
                        break;

                    case "–ò—Å—Ç–æ—Ä–∏—è":
                        $this->log->log("—Å–æ–∑–¥–∞–Ω–∏–µ —è—Ä–ª—ã–∫–∞");

                        $history = $this->bitlyApi->getExistLinks();
                        $content = "–ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫: \n\n";
                        foreach ($history as $i) {
                            $content .= $i['title'] . "\n";
                            $content .= "üîó " . $i['long_url'] ."\n\n". "‚û° ". $i['link'] . "\n---------\n";
                        }

                        $inlineKeyboards = [
                            "inline_keyboard" => [
                                [
                                    (object)[
                                        "text" => "<",
                                        "callback_data" => "google.com"
                                    ],
                                    (object)[
                                        "text" => ">",
                                        "callback_data" => "google.com"
                                    ]
                                ]
                            ]
                        ];

                        $this->inlineKeyboard($content, $chat_id, $inlineKeyboards);
                        $this->log->log("—è—Ä–ª—ã–∫ —Å–æ–∑–¥–∞–Ω");
                        break;

                    case "/help":
                    case "–ü–æ–º–æ—â—å":
                        $this->log->log("–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ");
                        $this->sendMessage("–ø–æ–º–æ—â—å", $chat_id);
                        $this->log->log("—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
                        break;
                    default:
                        $this->log->log("–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ");
                        $this->sendLink($message, $chat_id);
                        $this->log->log("—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
                }
            }

            $this->lastupdate = $update_id+1;
            if ($this->lastupdate > 1) {
                $this->config->write('main', "lastUpdateID", $this->lastupdate);
                $this->config->updateFile();
            }
            sleep(1);
        }
    }
}

